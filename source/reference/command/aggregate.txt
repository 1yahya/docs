=========
aggregate
=========

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. dbcommand:: aggregate

   Performs aggregation operation using the :doc:`aggregation pipeline
   </reference/operator/aggregation-pipeline>`. The pipeline allows
   users to process data from a collection with a sequence of
   stage-based manipulations.

   .. TODO will undergo a thorough rewrite during the agg doc rewrite

   The command has following syntax:

   .. versionchanged:: 3.2

   .. code-block:: javascript

      {
        aggregate: "<collection>",
        pipeline: [ <stage>, <...> ],
        explain: <boolean>,
        allowDiskUse: <boolean>,
        cursor: <document>,
        bypassDocumentValidation: <boolean>,
        readConcern: <document>
      }

   The :dbcommand:`aggregate` command takes the following fields as
   arguments:


   .. list-table::
      :header-rows: 1
      :widths: 20 20 80
   
      * - Field
   
        - Type
   
        - Description
   
      * - ``aggregate``
   
        - string
   
        - The name of the collection to as the input for the aggregation pipeline.
          
          
   
      * - ``pipeline``
   
        - array
   
        - An array of :doc:`aggregation pipeline stages
          </reference/operator/aggregation-pipeline>` that process and
          transform the document stream as part of the aggregation pipeline.
          
          
   
      * - ``explain``
   
        - boolean
   
        - Optional. Specifies to return the information on the processing of the pipeline.
          
          .. versionadded:: 2.6
          
          
   
      * - ``allowDiskUse``
   
        - boolean
   
        - Optional. Enables writing to temporary files. When set to ``true``, aggregation
          stages can write data to the :file:`_tmp` subdirectory in the
          :setting:`~storage.dbPath` directory.
          
          .. versionadded:: 2.6
          
          
   
      * - ``cursor``
   
        - document
   
        - Optional. Specify a document that contains options that control the creation
          of the cursor object.
          
          .. versionadded:: 2.6
          
          
   
      * - ``maxTimeMS``
   
        - non-negative integer
   
        - Optional. The maximum time period in milliseconds the :dbcommand:`getMore()` operation will 
          block waiting for new data to be inserted into the capped collection. 
          
          Requires that the cursor on which this :dbcommand:`getMore()` is acting is 
          an ``awaitData`` cursor. 
          See the ``awaitData`` parameter for :dbcommand:`find()`.
          
          
   
      * - ``bypassDocumentValidation``
   
        - boolean
   
        - Optional. Available only if you specify the :pipeline:`$out` aggregation
          operator.
          
          
          
          Enables :samp:`aggregate` to bypass document validation
          during the operation. This lets you insert documents that do not
          meet the validation requirements.
          
          .. versionadded:: 3.2
          
          
   
      * - ``readConcern``
   
        - document
   
        - Optional. Specifies the :term:`read concern`. The default level is
          :readconcern:`"local"`.
          
          .. include:: /includes/fact-enable-majority-readConcern.rst
          
          .. include:: /includes/usage-read-concern-majority.rst
          
          .. include:: /includes/fact-aggregate-readConcern.rst
          
          .. versionadded:: 3.2
          
          
   


.. versionchanged:: 2.6

   :doc:`aggregation pipeline </reference/operator/aggregation-pipeline>`
   introduces the :pipeline:`$out` operator to allow
   :dbcommand:`aggregate` command to store results to a collection.

For more information about the aggregation pipeline
:doc:`/core/aggregation-pipeline`, :doc:`/reference/aggregation`, and
:doc:`/core/aggregation-pipeline-limits`.

Example
-------

Aggregate Data with Multi-Stage Pipeline
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A collection ``articles`` contains documents such as the following:

.. code-block:: javascript

   {
      _id: ObjectId("52769ea0f3dc6ead47c9a1b2"),
      author: "abc123",
      title: "zzz",
      tags: [ "programming", "database", "mongodb" ]
   }

The following example performs an :dbcommand:`aggregate` operation on
the ``articles`` collection to calculate the count of each distinct
element in the ``tags`` array that appears in the collection.

.. code-block:: javascript

   db.runCommand(
      { aggregate: "articles",
        pipeline: [
                    { $project: { tags: 1 } },
                    { $unwind: "$tags" },
                    { $group: {
                                _id: "$tags",
                                count: { $sum : 1 }
                              }
                    }
                  ]
      }
   )

In the :binary:`~bin.mongo` shell, this operation can use the
:method:`~db.collection.aggregate()` helper as in the following:

.. code-block:: javascript

   db.articles.aggregate(
                          [
                             { $project: { tags: 1 } },
                             { $unwind: "$tags" },
                             { $group: {
                                         _id: "$tags",
                                         count: { $sum : 1 }
                                       }
                             }
                          ]
   )

.. note:: In 2.6 and later, the :method:`~db.collection.aggregate()`
   helper always returns a cursor.

.. include:: /includes/fact-agg-helper-exception.rst

Return Information on the Aggregation Operation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following aggregation operation sets the optional field ``explain``
to ``true`` to return information about the aggregation operation.

.. code-block:: javascript

   db.runCommand( { aggregate: "orders",
                    pipeline: [
                                { $match: { status: "A" } },
                                { $group: { _id: "$cust_id", total: { $sum: "$amount" } } },
                                { $sort: { total: -1 } }
                              ],
                    explain: true
                 } )

.. note:: The intended readers of the ``explain`` output document are humans, and
   not machines, and the output format is subject to change between
   releases.

.. seealso:: :method:`db.collection.aggregate()` method

Aggregate Data using External Sort
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Aggregation pipeline stages have :ref:`maximum memory use limit
<agg-memory-restrictions>`. To handle large datasets, set
``allowDiskUse`` option to ``true`` to enable writing data to
temporary files, as in the following example:

.. code-block:: javascript

   db.runCommand(
      { aggregate: "stocks",
        pipeline: [
                    { $project : { cusip: 1, date: 1, price: 1, _id: 0 } },
                    { $sort : { cusip : 1, date: 1 } }
                  ],
        allowDiskUse: true
      }
   )

.. seealso:: :method:`db.collection.aggregate()`


Aggregate Command Returns a Cursor
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note::
   Using the :dbcommand:`aggregate` command to return a cursor is a
   low-level operation, intended for authors of drivers. Most users
   should use the :method:`db.collection.aggregate()` helper provided
   in the :binary:`~bin.mongo` shell or in their driver. In 2.6 and
   later, the :method:`~db.collection.aggregate()` helper always
   returns a cursor.

The following command returns a document that contains results with
which to instantiate a cursor object.

.. code-block:: javascript

   db.runCommand(
      { aggregate: "records",
        pipeline: [
           { $project: { name: 1, email: 1, _id: 0 } },
           { $sort: { name: 1 } }
        ],
        cursor: { }
      }
   )

To specify an *initial* batch size, specify the ``batchSize`` in the
``cursor`` field, as in the following example:

.. code-block:: javascript

   db.runCommand(
      { aggregate: "records",
        pipeline: [
           { $project: { name: 1, email: 1, _id: 0 } },
           { $sort: { name: 1 } }
        ],
        cursor: { batchSize: 0 }
      }
   )

The ``{batchSize: 0 }`` document specifies the size of the *initial*
batch size only. Specify subsequent batch sizes to :ref:`OP_GET_MORE
<wire-op-get-more>` operations as with other MongoDB cursors. A
``batchSize`` of ``0`` means an empty first batch and is useful if you
want to quickly get back a cursor or failure message, without doing
significant server-side work.

Override Default Read Concern
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To override the default read concern level of :readconcern:`"local"`,
use the ``readConcern`` option.

The following operation on a replica set specifies a :doc:`read concern
</reference/read-concern>` of :readconcern:`"majority"` to read the
most recent copy of the data confirmed as having been written to a
majority of the nodes.

.. important::

   - .. include:: /includes/fact-enable-majority-readConcern.rst

   - .. include:: /includes/fact-aggregate-readConcern.rst

   - .. include:: /includes/fact-readConcern-most-recent-data-in-node.rst

.. code-block:: javascript

   db.runCommand( 
      { 
         aggregate: "orders",
         pipeline: [ { $match: { status: "A" } } ],
         readConcern: { level: "majority" }
      }
   )

.. include:: /includes/usage-read-concern-majority.rst

The :dbcommand:`getMore` command uses the ``readConcern`` level
specified in the originating :dbcommand:`aggregate` command.

.. seealso:: :method:`db.collection.aggregate()`
